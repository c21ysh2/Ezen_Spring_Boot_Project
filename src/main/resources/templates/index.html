<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weather App</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
            crossorigin="anonymous"
    />
    <script
            type="text/javascript"
            src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=2f76b9ff5693043658660eb94f70830e"
    ></script>
    <style>
        .bg-light-green {
            background-color: #90ee90; /* 연두색 */
        }
        .logo2 {
            width: 100px;
            animation: fadeIn 3s ease-in-out, spin 2s infinite; /* 천천히 나타나며 회전 */
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* 지도 크기 설정 */
        #map {
            width: 100%;
            height: 400px;
        }
    </style>
</head>

<body>
<nav class="navbar navbar-expand-lg bg-light-green">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">
            <img class="logo2" src="./img/logo.png" alt="로고" />
        </a>
        <button
                class="navbar-toggler"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent"
                aria-expanded="false"
                aria-label="Toggle navigation"
        >
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="/"
                    >커뮤니티</a
                    >
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">기상 퀴즈</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/user/news">기상 뉴스</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">랭킹</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" sec:authorize="isAnonymous()" th:href="@{/user/login}">로그인</a>
                    <a class="nav-link" sec:authorize="isAuthenticated()" th:href="@{/user/logout}">로그아웃</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" sec:authorize="isAnonymous()" href="/user/signup">회원가입</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" sec:authorize="isAuthenticated()" th:href="@{#}">마이페이지</a>
                </li>
                <li>

                    <span th:text="${#authorization.expression('isAuthenticated()') ? #authentication.name : ''}"></span>
                </li>
            </ul>
        </div>
    </div>
</nav>
<div class="container-fluid">
    <div class="row text-center">
        <div class="col-md-9">
            <div id="map"></div>
        </div>
        <div class="col-md-3" id="weather">
            <h6>서울</h6>
            <p>맑음</p>
            <p>하이</p>
            <p>하이</p>
            <p>Hi</p>
            <p>안녕ㅎ하세요</p>
            탕후루
            하이
            바이
            성진
        </div>
    </div>
</div>

<div id="weather1"></div>
<div id="location"></div>

<script>
    // 위치 정보 요청 함수
    function getLocation() {
        // Geolocation API 지원 여부 확인
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            document.getElementById("location").innerHTML =
                "Geolocation is not supported by this browser.";
        }
    }

    // 위치 정보를 성공적으로 받아온 경우 실행되는 함수
    function showPosition(position) {
        var latitude = position.coords.latitude;
        var longitude = position.coords.longitude;

        // 위치 정보를 HTML 요소에 표시
        var locationElement = document.getElementById("location");
        locationElement.innerHTML = `
                <p>Latitude: ${latitude}</p>
                <p>Longitude: ${longitude}</p>
            `;
        locationfunc(latitude, longitude);
    }

    // 위치 정보를 받아오는 도중 오류가 발생한 경우 실행되는 함수
    function showError(error) {
        var locationElement = document.getElementById("location");
        switch (error.code) {
            case error.PERMISSION_DENIED:
                locationElement.innerHTML =
                    "User denied the request for Geolocation.";
                break;
            case error.POSITION_UNAVAILABLE:
                locationElement.innerHTML = "Location information is unavailable.";
                break;
            case error.TIMEOUT:
                locationElement.innerHTML =
                    "The request to get user location timed out.";
                break;
            case error.UNKNOWN_ERROR:
                locationElement.innerHTML = "An unknown error occurred.";
                break;
        }
        locationfunc(33.2541205, 126.560076);
    }

    // 페이지 로드 시 위치 정보 요청
    window.onload = getLocation;
</script>


<script>

    function mapXY(x, y) {
        let mapContainer = document.getElementById("map"), // 지도를 표시할 div
            mapOption = {
                center: new kakao.maps.LatLng(x, y), // 지도의 중심좌표
                level: 14, // 지도의 확대 레벨
            };

        let map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

        // 마커가 표시될 위치입니다
        let markerPosition = new kakao.maps.LatLng(x, y);

        // 마커를 생성합니다
        let marker = new kakao.maps.Marker({
            position: markerPosition,
        });

        // 마커가 지도 위에 표시되도록 설정합니다
        marker.setMap(map);
    }
</script>

<!-- 소스출처 : http://www.kma.go.kr/weather/forecast/digital_forecast.jsp
내부에 있음 // 기상청에서 이걸 왜 공식적으로 공개하지 않을까? // // (사용
예) // var rs = dfs_xy_conv("toLL","60","127"); // console.log(rs.lat,
rs.lng); -->

<script language="javascript">
    //<!--
    //
    // LCC DFS 좌표변환을 위한 기초 자료
    //
    var RE = 6371.00877; // 지구 반경(km)
    var GRID = 5.0; // 격자 간격(km)
    var SLAT1 = 30.0; // 투영 위도1(degree)
    var SLAT2 = 60.0; // 투영 위도2(degree)
    var OLON = 126.0; // 기준점 경도(degree)
    var OLAT = 38.0; // 기준점 위도(degree)
    var XO = 43; // 기준점 X좌표(GRID)
    var YO = 136; // 기1준점 Y좌표(GRID)

    // LCC DFS 좌표변환 ( code : "toXY"(위경도->좌표, v1:위도, v2:경도), "toLL"(좌표->위경도,v1:x, v2:y) )
    function dfs_xy_conv(code, v1, v2) {
        var DEGRAD = Math.PI / 180.0;
        var RADDEG = 180.0 / Math.PI;

        var re = RE / GRID;
        var slat1 = SLAT1 * DEGRAD;
        var slat2 = SLAT2 * DEGRAD;
        var olon = OLON * DEGRAD;
        var olat = OLAT * DEGRAD;

        var sn =
            Math.tan(Math.PI * 0.25 + slat2 * 0.5) /
            Math.tan(Math.PI * 0.25 + slat1 * 0.5);
        sn = Math.log(Math.cos(slat1) / Math.cos(slat2)) / Math.log(sn);
        var sf = Math.tan(Math.PI * 0.25 + slat1 * 0.5);
        sf = (Math.pow(sf, sn) * Math.cos(slat1)) / sn;
        var ro = Math.tan(Math.PI * 0.25 + olat * 0.5);
        ro = (re * sf) / Math.pow(ro, sn);
        var rs = {};
        if (code == "toXY") {
            rs["lat"] = v1;
            rs["lng"] = v2;
            var ra = Math.tan(Math.PI * 0.25 + v1 * DEGRAD * 0.5);
            ra = (re * sf) / Math.pow(ra, sn);
            var theta = v2 * DEGRAD - olon;
            if (theta > Math.PI) theta -= 2.0 * Math.PI;
            if (theta < -Math.PI) theta += 2.0 * Math.PI;
            theta *= sn;
            rs["x"] = Math.floor(ra * Math.sin(theta) + XO + 0.5);
            rs["y"] = Math.floor(ro - ra * Math.cos(theta) + YO + 0.5);
        } else {
            rs["x"] = v1;
            rs["y"] = v2;
            var xn = v1 - XO;
            var yn = ro - v2 + YO;
            ra = Math.sqrt(xn * xn + yn * yn);
            if (sn < 0.0) -ra;
            var alat = Math.pow((re * sf) / ra, 1.0 / sn);
            alat = 2.0 * Math.atan(alat) - Math.PI * 0.5;

            if (Math.abs(xn) <= 0.0) {
                theta = 0.0;
            } else {
                if (Math.abs(yn) <= 0.0) {
                    theta = Math.PI * 0.5;
                    if (xn < 0.0) -theta;
                } else theta = Math.atan2(xn, yn);
            }
            var alon = theta / sn + olon;
            rs["lat"] = alat * RADDEG;
            rs["lng"] = alon * RADDEG;
        }
        return rs;
    }
    //-->
</script>

<script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"
></script>
<script>
    function locationfunc(xxx, yyy) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0"); // 1을 더한 후 두 자리 수로 맞춤
        const date = String(now.getDate()).padStart(2, "0");

        const formattedDate = `${year}${month}${date}`;

        console.log(formattedDate); // 예: 20240624

        console.log("locationfunc");
        var rs = dfs_xy_conv("toXY", xxx, yyy);

        const apiKey = "RJPEUzqySY-TxFM6spmPRQ"; // 여기에 자신의 OpenWeatherMap API 키를 입력하세요
        const url = `https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst?serviceKey=pT92G96xAGF0VK2U3O0kj%2BmVmHumwJTe08EgnL98rAQTQQxeaqyiD85Sx9nrgex5BOEZp81ZKdK3a1llX6TMfw%3D%3D&pageNo=1&numOfRows=1000&dataType=JSON&base_date=${formattedDate}&base_time=0500&nx=${rs.x}&ny=${rs.y}`;

        fetch(url)
            .then((response) => response.json())
            .then((data) => {
                console.log(data);
                console.log(data.response.body.items.item[0].category);
                console.log(data.response.body.items.item[0].fcstValue);
                var weather = document.getElementById("weather");
                weather.innerHTML = `
              <p>${data.response.body.items.item[0].fcstDate}</p>
              <p>온도: ${data.response.body.items.item[0].fcstValue}</p>
          `;
                console.log(rs.x);
                console.log(rs.y);
                console.log(xxx);
                console.log(yyy);
                mapXY(xxx, yyy);
            })
            .catch((error) =>
                console.error("Error fetching weather data:", error)
            );
    }
</script>
</body>
</html>
